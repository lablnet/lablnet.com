---
// @ts-ignore
import { getCollection, getEntry } from 'astro:content';

import PostLayout from '../../components/PostLayout.astro';
import PostInfo from '../../components/PostInfo.astro';
import Layout from '../../layouts/Layout.astro';
import { compareByDate, df } from '../../utils';

export async function getStaticPaths() {
	let companies = await getCollection('companies');
	return companies.map((entity) => ({
		params: { company: entity.data.company },
	}));
}

// Usage of getCollection to fetch companies
const { company } = Astro.params;

// get all companies where slug=companySlug
const companies = await getCollection('companies', (p) => p.data.company === company);

let title = companies.length > 0 ? companies[0].data.title : 'Company not found';
---

<Layout title={title}>
	{
		!companies
			? ''
			: companies.map(async (company: any) => {
					const { Content } = await company.render();
					// get all projects where project=ash
					const projects = await getCollection('projects', (p) => p.data.company === company.data.company);

					return (
						<PostLayout
							title={company.data.title}
							subtitle={company.data.subtitle ?? ''}
							coverPic={company.data.banner}
						>
							<div class="mt-4">
								<Content />
							</div>
							{!projects
								? ''
								: projects.map(async (project: any) => {
										const { Content } = await project.render();
										let endDate = project.data.endDate ? df.format(project.data.endDate) : 'Present';
										let subtitle :any = `${df.format(project.data.startDate)} - ${endDate}`;
										return (
											<div>
												<PostInfo
													stack={project.data.stacks}
													title={project.data.title}
													subtitle={subtitle}
													codeURL={project.data?.github ?? ''}
													siteURL={project.data.live}
													coverPic={project.data.coverPic}
													collaborators={project.data.collaborators}
												/>
												<div class="mt-4 prose">
													<Content />
												</div>
												<hr class="mt-12 mb-4" />
											</div>
										);
									})}
						</PostLayout>
					);
				})
	}
</Layout>